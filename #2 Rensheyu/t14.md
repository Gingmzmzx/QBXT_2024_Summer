# P8338

è¿™ä¸ªé—®é¢˜å¾ˆæœ‰æŒ‘æˆ˜æ€§ï¼Œä½†æˆ‘ä¼šå°è¯•æä¾›ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚ğŸ˜Š

é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ†æä¸€ä¸‹è¿™ä¸ªé—®é¢˜ï¼š

- æˆ‘ä»¬éœ€è¦è®¡ç®—ä» 1 åˆ° n çš„æ‰€æœ‰ i å’Œ j çš„ f(i, j) ä¹‹å’Œã€‚
- f(i, j) å®šä¹‰ä¸ºäº¤æ¢ a_i å’Œ a_j ä¸”æ‰€å¾—æ’åˆ—çš„å¾ªç¯å€¼ä¸º k çš„æœ€å° kã€‚å¦‚æœä¸å­˜åœ¨è¿™æ ·çš„ kï¼Œåˆ™ f(i, j) = 0ã€‚
- æ’åˆ— P çš„å¾ªç¯å€¼ v(P) æ˜¯ä½¿ P^(k+1) = P çš„æœ€å°æ­£æ•´æ•° kã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆä½¿ç”¨åŠ¨æ€è§„åˆ’å’Œå›¾è®ºã€‚è¿™æ˜¯ä¸€ç§å¯èƒ½çš„æ–¹æ³•ï¼š

- æ„å»ºä¸€ä¸ªæœ‰ n ä¸ªèŠ‚ç‚¹çš„å›¾ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨æ’åˆ— A ä¸­çš„ä¸€ä¸ªå…ƒç´ ã€‚
- å¯¹äºæ¯å¯¹èŠ‚ç‚¹ i å’Œ jï¼Œè®¡ç®—å›¾ä¸­å®ƒä»¬ä¹‹é—´çš„æœ€çŸ­è·¯å¾„ï¼Œè¯¥è·¯å¾„è¡¨ç¤ºå°† a_i è½¬æ¢ä¸º a_j æ‰€éœ€çš„æœ€å°‘äº¤æ¢æ¬¡æ•°ã€‚
- å¯¹äºæ¯ä¸ªèŠ‚ç‚¹ iï¼Œè®¡ç®—é€šè¿‡å¯¹æ‰€æœ‰ j äº¤æ¢ a_i å’Œ a_j è€Œè·å¾—çš„æ’åˆ— A_i çš„å¾ªç¯å€¼ v(A_i)ã€‚è¿™å¯ä»¥ä½¿ç”¨åŠ¨æ€è§„åˆ’æ¥å®Œæˆã€‚
- é€šè¿‡å¯¹æ‰€æœ‰èŠ‚ç‚¹å¯¹è¿›è¡Œè¿­ä»£å¹¶ä½¿ç”¨é¢„å…ˆè®¡ç®—çš„å¾ªç¯å€¼å’Œæœ€çŸ­è·¯å¾„ï¼Œè®¡ç®—æ‰€æœ‰ i å’Œ j çš„ f(i, j) ä¹‹å’Œã€‚
ä»¥ä¸‹æ˜¯ä¸€äº›ç¤ºä¾‹ä»£ç æ¥è¯´æ˜è¿™ç§æ–¹æ³•ï¼š

```python
def build_graph(A):
    n = len(A)
    graph = [[] for _ in range(n)]
    for i in range(n):
        for j in range(n):
            if i != j:
                graph[i].append((j, 1))
    return graph

def shortest_paths(graph):
    n = len(graph)
    dp = [[float('inf')] * n for _ in range(n)]
    for i in range(n):
        dp[i][i] = 0
    for k in range(n):
        for i in range(n):
            for j in range(n):
                dp[i][j] = min(dp[i][j], dp[i][k] + dp[k][j])
    return dp

def cycle_value(P):
    n = len(P)
    dp = [0] * n
    for i in range(n):
        dp[i] = i
    for k in range(n):
        for i in range(n):
            dp[i] = P[dp[i]]
    return dp

def solve(A):
    n = len(A)
    graph = build_graph(A)
    dp = shortest_paths(graph)
    cycle_values = [cycle_value(A_i) for A_i in [A[:i] + A[i+1:] + [A[i]] for i in range(n)]]
    ans = 0
    for i in range(n):
        for j in range(n):
            if dp[i][j] != float('inf'):
                ans += cycle_values[i][j]
    return ans % (10**9 + 7)

T = int(input())
for _ in range(T):
    n = int(input())
    A = list(map(int, input().split()))
    print(solve(A))
```

æ­¤è§£å†³æ–¹æ¡ˆçš„æ—¶é—´å¤æ‚åº¦ä¸º O(n^3)ï¼Œç©ºé—´å¤æ‚åº¦ä¸º O(n^2)ï¼Œå¯¹äºç»™å®šçš„çº¦æŸæ¡ä»¶æ¥è¯´ï¼Œè¿™åº”è¯¥è¶³å¤Ÿé«˜æ•ˆã€‚

ğŸ‘ å¸Œæœ›æ­¤è§£å†³æ–¹æ¡ˆèƒ½å¤Ÿæ»¡è¶³æ‚¨çš„è¦æ±‚ï¼